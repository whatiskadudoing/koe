name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          package-name: koe

  build-and-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build App
        run: |
          cd WhisperApp
          swift build -c release

      - name: Create App Bundle
        run: |
          cd WhisperApp

          # Find the executable
          EXECUTABLE=$(find .build -name "Koe" -type f -path "*release*" | grep -v dSYM | head -1)
          echo "Found executable: $EXECUTABLE"

          # Create .app bundle structure
          mkdir -p dist/Koe.app/Contents/MacOS
          mkdir -p dist/Koe.app/Contents/Resources

          # Copy executable
          cp "$EXECUTABLE" dist/Koe.app/Contents/MacOS/Koe

          # Copy Info.plist
          cp WhisperApp/Info.plist dist/Koe.app/Contents/Info.plist

          # Add CFBundleExecutable to Info.plist
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string Koe" dist/Koe.app/Contents/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable Koe" dist/Koe.app/Contents/Info.plist

          # Create PkgInfo
          echo -n "APPL????" > dist/Koe.app/Contents/PkgInfo

          # Make executable
          chmod +x dist/Koe.app/Contents/MacOS/Koe

          # Create ZIP
          cd dist
          zip -r Koe-macos-arm64.zip Koe.app

      - name: Build Installers
        run: |
          cd WhisperApp/installer

          # ARM64 (Apple Silicon)
          deno compile \
            --target aarch64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer-macos-arm64 \
            install.ts

          # x86_64 (Intel)
          deno compile \
            --target x86_64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer-macos-x64 \
            install.ts

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            WhisperApp/dist/Koe-macos-arm64.zip \
            WhisperApp/installer/koe-installer-macos-arm64 \
            WhisperApp/installer/koe-installer-macos-x64
