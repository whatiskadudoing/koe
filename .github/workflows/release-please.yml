name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          package-name: koe

  build-and-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build App
        run: |
          cd KoeApp
          swift build -c release

      - name: Create App Bundle
        run: |
          cd KoeApp

          # Find the executable
          EXECUTABLE=$(find .build -name "Koe" -type f -path "*release*" | grep -v dSYM | head -1)
          echo "Found executable: $EXECUTABLE"

          # Create .app bundle structure
          mkdir -p dist/Koe.app/Contents/MacOS
          mkdir -p dist/Koe.app/Contents/Resources

          # Copy executable
          cp "$EXECUTABLE" dist/Koe.app/Contents/MacOS/Koe

          # Copy Info.plist
          cp Koe/Info.plist dist/Koe.app/Contents/Info.plist

          # Add CFBundleExecutable to Info.plist
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string Koe" dist/Koe.app/Contents/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable Koe" dist/Koe.app/Contents/Info.plist

          # Create PkgInfo
          echo -n "APPL????" > dist/Koe.app/Contents/PkgInfo

          # Make executable
          chmod +x dist/Koe.app/Contents/MacOS/Koe

          # Ad-hoc sign with correct bundle identifier, entitlements, and stable designated requirement
          # The --requirements flag ensures TCC uses the identifier (not cdhash) for permission tracking
          codesign --force --deep --sign - --identifier "com.koe.voice" --entitlements Koe.entitlements --requirements '=designated => identifier "com.koe.voice"' dist/Koe.app
          echo "App signed with identifier: com.koe.voice"
          codesign -dv dist/Koe.app 2>&1
          codesign -d --entitlements :- dist/Koe.app 2>&1

          # Create ZIP
          cd dist
          zip -r Koe-macos-arm64.zip Koe.app

      - name: Build Installer
        run: |
          cd installer
          deno compile \
            --target aarch64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer \
            mod.ts

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            KoeApp/dist/Koe-macos-arm64.zip \
            installer/koe-installer
