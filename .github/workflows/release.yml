name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-app:
    name: Build Koe App
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: Build App (Release)
        run: |
          cd WhisperApp
          swift build -c release

      - name: Package App
        run: |
          cd WhisperApp
          mkdir -p dist

          # Find and copy the app bundle
          APP_PATH=$(find .build -name "Koe.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            cp -r "$APP_PATH" dist/
          fi

          # Create ZIP for release
          cd dist
          zip -r Koe-macos-arm64.zip Koe.app

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Koe-App
          path: WhisperApp/dist/Koe-macos-arm64.zip
          retention-days: 1

  build-installer:
    name: Build Installer
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build Installers
        run: |
          cd WhisperApp/installer

          # ARM64 (Apple Silicon)
          deno compile \
            --target aarch64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer-macos-arm64 \
            install.ts

          # x86_64 (Intel)
          deno compile \
            --target x86_64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer-macos-x64 \
            install.ts

      - name: Upload Installer Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Koe-Installers
          path: |
            WhisperApp/installer/koe-installer-macos-arm64
            WhisperApp/installer/koe-installer-macos-x64
          retention-days: 1

  release:
    name: Create Release
    needs: [build-app, build-installer]
    runs-on: ubuntu-latest

    steps:
      - name: Download App Artifact
        uses: actions/download-artifact@v4
        with:
          name: Koe-App
          path: artifacts/app

      - name: Download Installer Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Koe-Installers
          path: artifacts/installer

      - name: List Artifacts
        run: |
          echo "=== App ==="
          ls -la artifacts/app/
          echo "=== Installer ==="
          ls -la artifacts/installer/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/app/Koe-macos-arm64.zip
            artifacts/installer/koe-installer-macos-arm64
            artifacts/installer/koe-installer-macos-x64
          generate_release_notes: true
          body: |
            ## Koe 声 - Voice to Text

            ### Downloads

            | File | Description |
            |------|-------------|
            | `Koe-macos-arm64.zip` | Koe app for Apple Silicon Macs |
            | `koe-installer-macos-arm64` | Terminal installer for Apple Silicon |
            | `koe-installer-macos-x64` | Terminal installer for Intel Macs |

            ### Installation

            **Option 1: Download the app directly**
            1. Download `Koe-macos-arm64.zip`
            2. Unzip and move `Koe.app` to Applications
            3. Open Koe and grant accessibility permissions

            **Option 2: Use the terminal installer**
            ```bash
            # Apple Silicon
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/koe-installer-macos-arm64 -o koe-installer
            chmod +x koe-installer
            ./koe-installer
            ```

            ### Usage
            Hold **⌥ Space** anywhere to start recording, release to transcribe.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
