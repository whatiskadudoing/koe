name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-app:
    name: Build Koe App
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1"

      - name: Build App (Release)
        run: |
          cd WhisperApp
          swift build -c release

      - name: Create App Bundle
        run: |
          cd WhisperApp

          # Find the executable
          EXECUTABLE=$(find .build -name "Koe" -type f -path "*release*" | grep -v dSYM | head -1)
          echo "Found executable: $EXECUTABLE"

          # Create .app bundle structure
          mkdir -p dist/Koe.app/Contents/MacOS
          mkdir -p dist/Koe.app/Contents/Resources

          # Copy executable
          cp "$EXECUTABLE" dist/Koe.app/Contents/MacOS/Koe

          # Copy Info.plist
          cp WhisperApp/Info.plist dist/Koe.app/Contents/Info.plist

          # Add CFBundleExecutable to Info.plist
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string Koe" dist/Koe.app/Contents/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable Koe" dist/Koe.app/Contents/Info.plist

          # Create PkgInfo
          echo -n "APPL????" > dist/Koe.app/Contents/PkgInfo

          # Make executable
          chmod +x dist/Koe.app/Contents/MacOS/Koe

          # Create ZIP for release
          cd dist
          zip -r Koe-macos-arm64.zip Koe.app

          echo "App bundle created and zipped"
          ls -la

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Koe-App
          path: WhisperApp/dist/Koe-macos-arm64.zip
          retention-days: 1

  build-installer:
    name: Build Installer
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build Installer
        run: |
          cd WhisperApp/installer
          deno compile \
            --target aarch64-apple-darwin \
            --allow-read --allow-write --allow-net --allow-run --allow-env \
            --output koe-installer \
            mod.ts

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: koe-installer
          path: WhisperApp/installer/koe-installer
          retention-days: 1

  release:
    name: Create Release
    needs: [build-app, build-installer]
    runs-on: ubuntu-latest

    steps:
      - name: Download App Artifact
        uses: actions/download-artifact@v4
        with:
          name: Koe-App
          path: artifacts/app

      - name: Download Installer
        uses: actions/download-artifact@v4
        with:
          name: koe-installer
          path: artifacts/installer

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/app/Koe-macos-arm64.zip
            artifacts/installer/koe-installer
          generate_release_notes: true
          body: |
            ## Koe 声 - Voice to Text

            ### Install (Apple Silicon)

            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/koe-installer -o koe && chmod +x koe && ./koe
            ```

            Or download `Koe-macos-arm64.zip` and move to Applications.

            ### Usage
            Hold **⌥ Space** anywhere to transcribe.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
